<Window x:Class="M64RPFW.src.Views.MainWindow"
        x:Name="root"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:ext="clr-namespace:M64RPFW.src.Extensions"
        xmlns:extloc="clr-namespace:M64RPFW.src.Extensions.Localization"
        xmlns:extbin="clr-namespace:M64RPFW.src.Extensions.Bindings"
        xmlns:ui="http://schemas.modernwpf.com/2019" 
        xmlns:viewmodels="clr-namespace:M64RPFW.ViewModels;assembly=M64RPFW.ViewModels" 
        d:DataContext="{d:DesignInstance Type=viewmodels:MainViewModel}"
        mc:Ignorable="d"
        Title="{extloc:Localization AppName}" 
        Width="800"
        Height="450"
        ui:WindowHelper.UseModernWindowStyle="True"
        Closing="Window_Closing">

    <Window.Resources>
        <extbin:BindingProxy x:Key="MainViewModelProxy" Data="{Binding}"/>
        <extbin:BindingProxy x:Key="RootProxy" Data="{Binding ElementName=root}"/>
        <ext:CommandReference x:Key="TogglePauseCommandReference" Command="{Binding EmulatorViewModel.TogglePauseCommand}"/>
        <ext:CommandReference x:Key="FrameAdvanceCommandReference" Command="{Binding EmulatorViewModel.FrameAdvanceCommand}"/>
        <ext:CommandReference x:Key="ShowSettingsWindowCommandReference" Command="{Binding ShowSettingsWindowCommand, ElementName=root}"/>
    </Window.Resources>

    <Window.InputBindings>
        <KeyBinding x:Name="TogglePauseInputBinding" Key="P" Command="{StaticResource TogglePauseCommandReference}" />
        <KeyBinding x:Name="FrameAdvanceInputBinding" Key="OemBackslash" Command="{StaticResource FrameAdvanceCommandReference}" />
        <KeyBinding x:Name="FrameAdvanceInputBinding2" Key="Oem5" Command="{StaticResource FrameAdvanceCommandReference}" />
        <KeyBinding x:Name="ShowSettingsInputBinding" Key="S" Modifiers="Ctrl" Command="{StaticResource ShowSettingsWindowCommandReference}" />
    </Window.InputBindings>

    <Grid
        HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
        <Grid>
            <DockPanel LastChildFill="True" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                <Menu IsMainMenu="True" Height="40" DockPanel.Dock="Top" VerticalAlignment="Stretch">
                    <MenuItem Header="{extloc:Localization File}">
                        <MenuItem Header="{extloc:Localization LoadROM}" Command="{Binding EmulatorViewModel.LoadROMCommand, IsAsync=True}"/>
                        <MenuItem Header="Recent ROMs" ItemsSource="{Binding RecentROMsViewModel.RecentROMs, UpdateSourceTrigger=PropertyChanged}" UsesItemContainerTemplate="True">
                            <MenuItem.Resources>

                                <!--  x:Key vs DataType menuitem issue here: https://github.com/dotnet/wpf/issues/2404  -->
                                <ItemContainerTemplate x:Key="{ItemContainerTemplateKey {x:Type viewmodels:ROMViewModel}}">
                                    <MenuItem
                                Command="{Binding ElementName=root, Path=DataContext.EmulatorViewModel.LoadROMFromPathCommand}"
                                CommandParameter="{Binding Path}"
                                Header="{Binding}">
                                        <MenuItem.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem Header="{extloc:Localization Remove}" 
                                                          Command="{Binding Source={StaticResource MainViewModelProxy}, Path=Data.RecentROMsViewModel.RemoveRecentROMCommand}" 
                                                          CommandParameter="{Binding}"/>
                                                <Separator/>
                                                <MenuItem Header="{extloc:Localization Inspect}" 
                                                          Command="{Binding Source={StaticResource RootProxy}, Path=Data.ShowROMInspectionWindowCommand}"
                                                          CommandParameter="{Binding}"/>
                                            </ContextMenu>
                                        </MenuItem.ContextMenu>
                                    </MenuItem>
                                </ItemContainerTemplate>

                            </MenuItem.Resources>
                        </MenuItem>
                        <MenuItem Header="{extloc:Localization CloseROM}" Command="{Binding EmulatorViewModel.CloseROMCommand}" IsEnabled="{Binding EmulatorViewModel.IsRunning}" />
                        <MenuItem Header="{extloc:Localization ResetROM}" Command="{Binding EmulatorViewModel.ResetROMCommand}" IsEnabled="{Binding EmulatorViewModel.IsRunning}"/>
                        <Separator/>
                        <MenuItem Header="{extloc:Localization Exit}" Command="{Binding ExitCommand, ElementName=root}"/>
                    </MenuItem>
                    <MenuItem Header="{extloc:Localization Emulation}" IsEnabled="{Binding EmulatorViewModel.IsRunning}">
                        <MenuItem Header="{extloc:Localization Pause}" IsCheckable="True" IsChecked="{Binding EmulatorViewModel.IsResumed, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, Converter={StaticResource InvertBooleanConverter}}" InputGestureText="{Binding ElementName=TogglePauseInputBinding, Converter={StaticResource KeyBindingToStringConverter}}"/>
                        <Separator/>
                        <MenuItem Header="{extloc:Localization FrameAdvance}" Command="{Binding EmulatorViewModel.FrameAdvanceCommand}" InputGestureText="{Binding ElementName=FrameAdvanceInputBinding, Converter={StaticResource KeyBindingToStringConverter}}"/>
                    </MenuItem>
                    <MenuItem Header="{extloc:Localization Options}">
                        <MenuItem Header="{extloc:Localization PluginSettings}">
                            <MenuItem Header="{extloc:Localization Video}" />
                            <MenuItem Header="{extloc:Localization Audio}" />
                            <MenuItem Header="{extloc:Localization Input}" />
                            <MenuItem Header="{extloc:Localization RSP}" />
                        </MenuItem>
                        <Separator/>
                        <MenuItem x:Name="ShowStatusbar_MenuItem" Header="{extloc:Localization ShowStatusbar}" IsCheckable="True" IsChecked="{extbin:SettingsBinding ShowStatusbar, Mode=TwoWay}"/>
                        <Separator/>
                        <MenuItem Header="{extloc:Localization ProgramSettings}" Command="{Binding ShowSettingsWindowCommand, ElementName=root}" InputGestureText="{Binding ElementName=ShowSettingsInputBinding, Converter={StaticResource KeyBindingToStringConverter}}"/>
                    </MenuItem>
                </Menu>
                
                <StatusBar Height="40" HorizontalAlignment="Stretch" VerticalAlignment="Bottom" Visibility="{Binding ElementName=ShowStatusbar_MenuItem, Path=IsChecked, Converter={StaticResource BooleanToVisibilityConverter}}" DockPanel.Dock="Bottom">
                    <StackPanel Orientation="Horizontal" Margin="0 0 0 0">
                        <StackPanel.Resources>
                            <Style TargetType="Separator">
                                <Setter Property="LayoutTransform" Value="{StaticResource VerticalRotateTransform}"/>
                                <Setter Property="Margin" Value="5 0 5 0"/>
                            </Style>
                        </StackPanel.Resources>
                        <TextBlock Text="Placeholder" Margin="5 0 0 0"/>
                        <Separator/>
                        <TextBlock Text="d"/>
                    </StackPanel>
                </StatusBar>

                <Image x:Name="Main_Image"/>
                <!-- DockPanel layout trick: Place this as last element to fill parent -->
            </DockPanel>
        </Grid>
    </Grid>
</Window>
